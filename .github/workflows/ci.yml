name: Tests & Create PR

on:
  push:
    branches:
      - test   # quand tu pushes sur test

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'

      - name: Copie .env.test to .env.test.local
        run: cp .env.test .env.test.local

      - name: Installer les d√©pendances
        run: composer install --no-progress --no-interaction --prefer-dist --optimize-autoloader

      - name: Lancer les tests
        run: ./vendor/bin/phpunit --testdox

  create-pr:
    needs: tests
    runs-on: ubuntu-latest
    if: success()   # seulement si les tests passent
    steps:
      - name: Cr√©er une Pull Request vers main
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: test
          base: main
          title: "Merge test into main"
          body: |
            Cette PR a √©t√© cr√©√©e automatiquement apr√®s que les tests ont r√©ussi.
            Merci de la r√©viser et de la merger manuellement si tout est OK.
          draft: false   # üëà PR normale (√† toi de valider)